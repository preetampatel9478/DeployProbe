<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Metadata -->
    <title>{{ meta.title }}</title>
    <meta name="description" content="{{ meta.description }}">
    <meta name="keywords" content="{{ meta.keywords }}">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="{{ meta.title }}"></meta>
    <meta property="og:description" content="{{ meta.description }}"></meta>
    <meta property="og:image" content="{{ meta.og_image }}"></meta>
    <meta property="og:url" content="{{ meta.canonical }}"></meta>
    <meta property="og:type" content="website"></meta>
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="{{ meta.twitter_card }}"></meta>
    <meta name="twitter:title" content="{{ meta.title }}"></meta>
    <meta name="twitter:description" content="{{ meta.description }}"></meta>
    <meta name="twitter:image" content="{{ meta.og_image }}"></meta>
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ meta.canonical }}"></link>
    
    {% if meta.get('noindex', False) %}
    <meta name="robots" content="noindex, nofollow"></meta>
    {% endif %}
    
    <link rel="icon" href="{{ url_for('static', filename='img/fev.png') }}" type="image/png"></link>
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/fev.png') }}" type="image/png"></link>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></link>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"></link>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"></link>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="DeployProbe Logo" class="logo-img">
                <span class="brand-text">DeployProbe</span>
            </a>
            <div class="navbar-text text-light d-none d-md-block">
                Deployed it? Let's see if it survives the storm.
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h1 class="h4 mb-0">Brewing The Storm</h1>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <h2 class="h5 mb-2">Testing <span class="text-primary">{{ url }}</span></h2>
                            <div class="target-capacity mb-4">
                                <span class="badge bg-info p-2">
                                    <i class="bi bi-cloud-lightning me-1"></i> Simulating {{ '{:,}'.format(user_capacity) }} user storm
                                </span>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress" style="height: 25px;">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                                <div id="progress-message" class="text-center mt-3 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span>Initializing high capacity tests...</span>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <div class="d-grid testing-stages">
                                    <div id="stage-1" class="testing-stage">
                                        <span class="stage-icon"><i class="bi bi-arrow-repeat"></i></span>
                                        <span class="stage-text">Checking site availability</span>
                                    </div>
                                    <!-- REORDERED - CODE QUALITY MOVED TO 2ND POSITION -->
                                    <div id="stage-2" class="testing-stage">
                                        <span class="stage-icon"><i class="bi bi-code-square"></i></span>
                                        <span class="stage-text">Evaluating code quality & scalability</span>
                                    </div>
                                    <div id="stage-3" class="testing-stage">
                                        <span class="stage-icon"><i class="bi bi-file-text"></i></span>
                                        <span class="stage-text">Analyzing content structure</span>
                                    </div>
                                    <div id="stage-4" class="testing-stage">
                                        <span class="stage-icon"><i class="bi bi-phone"></i></span>
                                        <span class="stage-text">Testing mobile responsiveness</span>
                                    </div>
                                    <div id="stage-5" class="testing-stage">
                                        <span class="stage-icon"><i class="bi bi-speedometer"></i></span>
                                        <span class="stage-text">Measuring page speed metrics</span>
                                    </div>
                                    <div id="stage-6" class="testing-stage">
                                        <span class="stage-icon"><i class="bi bi-people"></i></span>
                                        <span class="stage-text">Running standard load tests</span>
                                    </div>
                                    <div id="stage-7" class="testing-stage">
                                        <span class="stage-icon"><i class="bi bi-graph-up"></i></span>
                                        <span class="stage-text">Simulating high concurrency</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="error-message" class="alert alert-danger d-none">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span>An error occurred during testing.</span>
                        </div>
                        
                        <div id="testing-complete" class="text-center mt-4 d-none">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <span>Testing complete! Analyzing capacity for {{ '{:,}'.format(user_capacity) }} users...</span>
                            </div>
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <p class="text-muted"><small>DeployProbe is analyzing if your site can withstand a storm of {{ '{:,}'.format(user_capacity) }} concurrent users.</small></p>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-center text-md-start">
                    <p class="mb-0">
                        <strong>DeployProbe</strong> - Deployed it? Let's see if it survives the storm.
                    </p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="text-muted mb-0">&copy; 2023 DeployProbe</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const testId = "{{ test_id }}";
            const url = "{{ url }}";
            let intervalId;
            
            // Function to poll progress status
            function checkProgress() {
                fetch(`/progress/${testId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Update progress bar
                        const progressBar = document.getElementById('progress-bar');
                        const progressMessage = document.getElementById('progress-message');
                        const progress = data.progress || 0;
                        
                        progressBar.style.width = `${progress}%`;
                        progressBar.setAttribute('aria-valuenow', progress);
                        progressBar.textContent = `${progress}%`;
                        
                        // Update message
                        if (data.message) {
                            progressMessage.innerHTML = `<span>${data.message}</span>`;
                        }
                        
                        // Update testing stages
                        updateStages(progress);
                        
                        // Check if testing is complete
                        if (data.status === 'completed') {
                            clearInterval(intervalId);
                            document.getElementById('testing-complete').classList.remove('d-none');
                            
                            // Redirect to results page after a short delay
                            setTimeout(() => {
                                window.location.href = `/results/${testId}?url=${encodeURIComponent(url)}`;
                            }, 1500);
                        }
                        
                        // Check for errors
                        if (data.status === 'error') {
                            clearInterval(intervalId);
                            const errorMessage = document.getElementById('error-message');
                            errorMessage.classList.remove('d-none');
                            errorMessage.querySelector('span').textContent = data.message || 'An error occurred during testing.';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching progress:', error);
                    });
            }
            
            // Function to update the testing stages visualization
            function updateStages(progress) {
                // Clear all active stages first
                document.querySelectorAll('.testing-stage').forEach(stage => {
                    stage.classList.remove('stage-active', 'stage-completed');
                });
                
                // Determine which stages are active or completed
                if (progress >= 10) {
                    document.getElementById('stage-1').classList.add('stage-completed');
                } else {
                    document.getElementById('stage-1').classList.add('stage-active');
                    return;
                }
                
                if (progress >= 25) {
                    document.getElementById('stage-2').classList.add('stage-completed');
                } else {
                    document.getElementById('stage-2').classList.add('stage-active');
                    return;
                }
                
                if (progress >= 40) {
                    document.getElementById('stage-3').classList.add('stage-completed');
                } else {
                    document.getElementById('stage-3').classList.add('stage-active');
                    return;
                }
                
                if (progress >= 50) {
                    document.getElementById('stage-4').classList.add('stage-completed');
                } else {
                    document.getElementById('stage-4').classList.add('stage-active');
                    return;
                }
                
                if (progress >= 60) {
                    document.getElementById('stage-5').classList.add('stage-completed');
                } else {
                    document.getElementById('stage-5').classList.add('stage-active');
                    return;
                }
                
                if (progress >= 70) {
                    document.getElementById('stage-6').classList.add('stage-completed');
                } else {
                    document.getElementById('stage-6').classList.add('stage-active');
                    return;
                }
                
                if (progress >= 90) {
                    document.getElementById('stage-7').classList.add('stage-completed');
                } else {
                    document.getElementById('stage-7').classList.add('stage-active');
                    return;
                }
                
                if (progress === 100) {
                    document.getElementById('stage-7').classList.remove('stage-active');
                    document.getElementById('stage-7').classList.add('stage-completed');
                }
            }
            
            // Start polling for progress
            intervalId = setInterval(checkProgress, 1000);
            
            // Do initial check
            checkProgress();
        });
    </script>
</body>
</html>
